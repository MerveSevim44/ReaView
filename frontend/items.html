<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ƒ∞√ßerik Detayƒ± ‚Ä¢ BiblioNet</title>
  <link rel="stylesheet" href="./css/style.css" />
  <link rel="stylesheet" href="./css/item.css" />
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      min-height: 100vh;
    }

    main {
      padding: 40px 20px;
      max-width: 1000px;
      margin: 0 auto;
    }

    /* ============ HEADER ============ */
    header {
      background: rgba(255, 255, 255, 0.95);
      padding: 20px 0;
      border-bottom: none;
      margin-bottom: 30px;
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 100;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    nav {
      max-width: 1000px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .nav-btn {
      background: none;
      border: none;
      color: #667eea;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      padding: 10px 16px;
      transition: all 0.3s ease;
      border-radius: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-btn:hover {
      background: rgba(102, 126, 234, 0.1);
      transform: translateX(-4px);
    }

    /* ============ CONTAINER ============ */
    .detail-container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      animation: fadeInUp 0.5s ease;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .detail-header {
      display: grid;
      grid-template-columns: 250px 1fr;
      gap: 35px;
      padding: 35px;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
    }

    .detail-cover {
      position: relative;
      perspective: 1000px;
      max-height: 500px;
    }

    .detail-cover img {
      width: 100%;
      height: auto;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      animation: zoomIn 0.5s ease;
      max-height: 400px;
      object-fit: cover;
    }

    @keyframes zoomIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .detail-cover:hover img {
      transform: scale(1.05) rotateY(2deg);
    }

    .type-badge {
      position: absolute;
      top: 16px;
      right: 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 10px 18px;
      border-radius: 20px;
      font-weight: 700;
      font-size: 13px;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      animation: slideInRight 0.4s ease;
      letter-spacing: 0.5px;
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .detail-info h1 {
      font-size: 28px;
      color: #1a1a2e;
      margin-bottom: 10px;
      font-weight: 700;
      letter-spacing: -0.5px;
      animation: fadeInUp 0.5s ease 0.1s both;
      word-break: break-word;
    }

    .source-badge {
      display: inline-block;
      padding: 6px 14px;
      background: linear-gradient(135deg, #fff3cd 0%, #ffe99f 100%);
      color: #856404;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 700;
      margin-top: 10px;
      animation: fadeIn 0.5s ease 0.2s both;
      letter-spacing: 0.3px;
    }

    .detail-meta {
      margin-bottom: 20px;
      margin-top: 15px;
    }

    .meta-item {
      margin-bottom: 8px;
      color: #555;
      font-size: 13px;
      line-height: 1.5;
      animation: fadeInUp 0.5s ease forwards;
      opacity: 0;
      word-break: break-word;
    }

    .meta-item:nth-child(1) { animation-delay: 0.15s; }
    .meta-item:nth-child(2) { animation-delay: 0.2s; }
    .meta-item:nth-child(3) { animation-delay: 0.25s; }
    .meta-item:nth-child(4) { animation-delay: 0.3s; }
    .meta-item:nth-child(5) { animation-delay: 0.35s; }
    .meta-item:nth-child(6) { animation-delay: 0.4s; }

    .meta-label {
      font-weight: 700;
      color: #667eea;
    }

    /* ============ RATING ============ */
    .rating-box {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 25px;
      border: 1px solid rgba(102, 126, 234, 0.2);
      animation: fadeInUp 0.5s ease 0.45s both;
      backdrop-filter: blur(10px);
    }

    .rating-display {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 15px;
    }

    .rating-big {
      font-size: 48px;
      font-weight: 800;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      min-width: 70px;
      animation: scaleIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) 0.5s both;
    }

    .rating-info {
      flex: 1;
    }

    .rating-text {
      font-size: 13px;
      color: #666;
      margin-bottom: 3px;
      font-weight: 600;
      line-height: 1.3;
    }

    .rating-stars {
      font-size: 16px;
      margin-top: 4px;
      animation: fadeIn 0.5s ease 0.6s both;
      letter-spacing: 1px;
    }

    .rating-input-group {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(102, 126, 234, 0.2);
      animation: fadeInUp 0.5s ease 0.55s both;
      flex-wrap: wrap;
    }

    .rating-label {
      font-weight: 700;
      color: #333;
      font-size: 13px;
      white-space: nowrap;
    }

    .rating-stars-input {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .star-btn {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      filter: opacity(0.4);
      padding: 0;
      margin: 0;
    }

    .star-btn:hover {
      transform: scale(1.25) rotate(10deg);
      filter: opacity(1);
    }

    .star-btn.selected {
      filter: drop-shadow(0 0 6px gold) opacity(1);
      animation: bounce 0.4s ease;
    }

    @keyframes bounce {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }

    .submit-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      font-size: 14px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      letter-spacing: 0.5px;
    }

    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
    }

    .submit-btn:active {
      transform: translateY(0);
    }

    /* ============ ACTION BUTTONS ============ */
    .action-buttons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 20px;
      animation: fadeInUp 0.5s ease 0.5s both;
    }

    .action-btn {
      padding: 12px 16px;
      border: 2px solid #667eea;
      background: white;
      color: #667eea;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
      font-size: 13px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
      letter-spacing: 0.3px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .action-btn:hover {
      background: #667eea;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.25);
    }

    .action-btn.secondary {
      border-color: #764ba2;
      color: #764ba2;
      box-shadow: 0 2px 8px rgba(118, 75, 162, 0.1);
    }

    .action-btn.secondary:hover {
      background: #764ba2;
      color: white;
      box-shadow: 0 6px 16px rgba(118, 75, 162, 0.25);
    }

    /* ============ DESCRIPTION ============ */
    .description-section {
      padding: 20px;
      border-top: 2px solid rgba(0, 0, 0, 0.05);
      animation: fadeIn 0.5s ease 0.6s both;
    }

    .section-title {
      font-size: 18px;
      font-weight: 700;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 12px;
      letter-spacing: -0.3px;
    }

    .description-text {
      color: #555;
      line-height: 1.6;
      font-size: 14px;
      word-break: break-word;
    }

    /* ============ COMMENTS ============ */
    .comments-section {
      padding: 20px;
      border-top: 2px solid rgba(0, 0, 0, 0.05);
      animation: fadeIn 0.5s ease 0.7s both;
    }

    .comment-form {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 1px solid rgba(102, 126, 234, 0.2);
      backdrop-filter: blur(10px);
    }

    .comment-form textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid rgba(102, 126, 234, 0.3);
      border-radius: 8px;
      font-size: 13px;
      font-family: inherit;
      resize: vertical;
      min-height: 80px;
      margin-bottom: 10px;
      transition: all 0.3s ease;
      background: white;
      color: #333;
      box-sizing: border-box;
    }

    .comment-form textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
      background: white;
    }

    .comments-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .ratings-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .comment-item {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
      padding: 16px;
      border-radius: 10px;
      border-left: 3px solid #667eea;
      transition: all 0.3s ease;
      animation: slideInLeft 0.4s ease;
    }

    @keyframes slideInLeft {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .comment-item:hover {
      transform: translateX(2px);
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
    }

    .comment-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
      flex-wrap: wrap;
      gap: 8px;
    }

    .comment-user {
      font-weight: 700;
      color: #667eea;
      font-size: 13px;
    }

    .comment-date {
      font-size: 11px;
      color: #999;
      font-weight: 500;
    }

    .comment-text {
      color: #555;
      line-height: 1.5;
      font-size: 13px;
      margin-bottom: 8px;
      word-break: break-word;
    }

    .comment-actions {
      display: flex;
      gap: 10px;
    }

    .comment-btn {
      background: none;
      border: none;
      color: #667eea;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 4px;
      transition: all 0.3s ease;
    }

    .comment-btn:hover {
      color: white;
      background: #667eea;
      transform: translateY(-1px);
    }

    /* ============ RATING ITEM STYLES ============ */
    .rating-item {
      background: linear-gradient(135deg, rgba(255, 193, 7, 0.05) 0%, rgba(255, 152, 0, 0.05) 100%);
      padding: 16px;
      border-radius: 10px;
      border-left: 3px solid #ffc107;
      transition: all 0.3s ease;
      animation: slideInLeft 0.4s ease;
    }

    .rating-item:hover {
      transform: translateX(2px);
      box-shadow: 0 2px 8px rgba(255, 193, 7, 0.1);
    }

    .rating-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
      flex-wrap: wrap;
      gap: 8px;
    }

    .rating-user {
      font-weight: 700;
      color: #ff9800;
      font-size: 13px;
    }

    .rating-date {
      font-size: 11px;
      color: #999;
      font-weight: 500;
    }

    .rating-actions {
      display: flex;
      gap: 10px;
      margin-top: 8px;
    }

    /* ============ EMPTY STATE ============ */
    .empty-state {
      text-align: center;
      padding: 30px;
      color: #999;
      animation: fadeIn 0.5s ease;
      font-size: 14px;
    }

    .loading {
      text-align: center;
      padding: 30px;
      color: #667eea;
      animation: fadeIn 0.5s ease;
      font-size: 14px;
    }

    .loading::after {
      content: '';
      display: inline-block;
      width: 8px;
      height: 8px;
      margin-left: 8px;
      background: #667eea;
      border-radius: 50%;
      animation: blink 1.4s infinite;
    }

    @keyframes blink {
      0%, 20%, 50%, 80%, 100% { opacity: 0.3; }
      40% { opacity: 1; }
      60% { opacity: 0.5; }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ============ MODAL/POPUP ============ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.3s ease;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 400px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      animation: slideInUp 0.3s ease;
      padding: 0;
    }

    .modal-header {
      padding: 20px;
      border-bottom: 2px solid rgba(102, 126, 234, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      font-size: 20px;
      color: #1a1a2e;
      margin: 0;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #999;
      transition: all 0.3s ease;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      color: #667eea;
      transform: rotate(90deg);
    }

    .modal-body {
      padding: 20px;
    }

    .list-sorting-controls {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .sort-btn {
      flex: 1;
      min-width: 90px;
      padding: 8px 12px;
      background: #f0f0f0;
      border: 2px solid #ddd;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 12px;
      color: #666;
      transition: all 0.3s ease;
    }

    .sort-btn:hover {
      background: #e8e8e8;
      border-color: #667eea;
      color: #667eea;
    }

    .sort-btn.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: #667eea;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .list-item {
      padding: 12px 16px;
      margin-bottom: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
    }

    .list-item:hover {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      transform: translateX(4px);
      border-color: #667eea;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .list-item-name {
      font-weight: 700;
      color: #1a1a2e;
      display: block;
    }

    .list-item:hover .list-item-name {
      color: white;
    }

    .list-item-description {
      font-size: 12px;
      color: #666;
      font-weight: 400;
      margin-top: 4px;
      opacity: 0.8;
    }

    .list-item:hover .list-item-description {
      color: rgba(255, 255, 255, 0.85);
    }

    .list-item:hover .list-delete-btn {
      opacity: 1;
    }

    .list-item-count {
      font-size: 12px;
      opacity: 0.7;
      font-weight: 600;
      white-space: nowrap;
    }

    .list-item:hover .list-item-count {
      opacity: 1;
      color: white;
    }

    .list-delete-btn {
      background: none;
      border: none;
      color: #999;
      font-size: 16px;
      cursor: pointer;
      padding: 4px 8px;
      opacity: 0.6;
      transition: all 0.3s ease;
    }

    .list-delete-btn:hover {
      opacity: 1;
      color: #ff4757;
      transform: scale(1.2);
    }

    .new-list-btn {
      width: 100%;
      padding: 12px 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
      font-size: 14px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      margin-top: 10px;
    }

    .new-list-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
    }

    .new-list-input {
      width: 100%;
      padding: 10px;
      border: 2px solid #667eea;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 10px;
      box-sizing: border-box;
      transition: all 0.3s ease;
    }

    .new-list-input:focus {
      outline: none;
      border-color: #764ba2;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .modal-btn-cancel {
      flex: 1;
      padding: 10px;
      background: #f0f0f0;
      color: #333;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .modal-btn-cancel:hover {
      background: #e0e0e0;
    }

    .modal-btn-create {
      flex: 1;
      padding: 10px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }

    .modal-btn-create:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .empty-lists {
      text-align: center;
      padding: 30px 20px;
      color: #999;
    }

    .empty-lists p {
      margin-bottom: 15px;
      font-size: 14px;
    }

    @media (max-width: 768px) {
      .detail-header {
        grid-template-columns: 1fr;
        gap: 20px;
        padding: 20px 15px;
      }

      .detail-cover {
        max-width: 100%;
      }

      .detail-info h1 {
        font-size: 22px;
      }

      .action-buttons {
        grid-template-columns: 1fr;
        gap: 10px;
      }

      .action-btn {
        padding: 10px 14px;
        font-size: 12px;
      }

      .rating-display {
        flex-direction: column;
        align-items: flex-start;
      }

      main {
        padding: 15px 10px;
      }

      .description-section,
      .comments-section {
        padding: 15px 10px;
      }

      .rating-box {
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <header>
    <nav>
      <button class="nav-btn" onclick="window.history.back()">‚Üê Geri</button>
    </nav>
  </header>

  <main>
    <div id="loading" class="loading">‚è≥ Y√ºkleniyor...</div>
    <div id="content" style="display: none;"></div>
    <div id="error" class="empty-state" style="display: none;"></div>
  </main>

  <!-- MODAL: √ñzel Listeye Ekle -->
  <div id="listModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üìã √ñzel Listeye Ekle</h2>
        <button class="modal-close" onclick="closeListModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <div id="existingLists"></div>
        <div id="newListForm" style="display: none;">
          <input 
            type="text" 
            id="newListName" 
            class="new-list-input" 
            placeholder="Liste adƒ±..." 
            onkeypress="handleEnter(event)"
          />
          <textarea 
            id="newListDescription" 
            class="new-list-input" 
            placeholder="Liste a√ßƒ±klamasƒ± (opsiyonel)..." 
            style="resize: vertical; min-height: 60px; font-family: inherit;"
          ></textarea>
          <div class="modal-actions">
            <button class="modal-btn-cancel" onclick="cancelNewList()">ƒ∞ptal</button>
            <button class="modal-btn-create" onclick="createNewList()">Olu≈ütur</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "https://reaview.vercel.app";
    const API_URL = `${API_BASE}/items`;

    let currentItem = null;
    let currentUser = { user_id: 1, username: "demo_user" };
    
    // Load current user from session (localStorage)
    try {
      const savedUser = localStorage.getItem("currentUser");
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
      }
    } catch (error) {
      console.error("Oturum y√ºkleme hatasƒ±:", error);
    }
    
    let selectedRating = 0;
    let isExternalItem = false;

    const urlParams = new URLSearchParams(window.location.search);
    const itemId = urlParams.get('id');
    const itemSource = urlParams.get('source'); // 'db' veya 'api'
    console.log('üìç URL Parametreleri:', { itemSource, itemIdLength: itemId?.length, fullUrl: window.location.href });
    console.log('‚ö†Ô∏è URL Search String:', window.search);
    console.log('üîç T√ºm parametreler:', Object.fromEntries(urlParams));

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('tr-TR', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function renderStars(rating) {
      const stars = Math.floor(rating / 2);
      const remainder = rating % 2;
      let result = '‚≠ê'.repeat(stars);
      if (remainder !== 0) result += '‚ú®';
      return result || 'Hen√ºz Puan Yok';
    }

    async function loadItemDetails() {
      try {
        console.log('üîÑ loadItemDetails ba≈üladƒ±:', { itemSource, itemIdLength: itemId?.length });
        console.log('üîç itemSource exact value:', itemSource, 'Type:', typeof itemSource, 'Equals api?:', itemSource === 'api', 'Includes api?:', itemSource?.includes?.('api'));
        
        if (itemSource === 'api') {
          // API'den gelen veri
          if (!itemId) {
            throw new Error('API item ID parametresi eksik');
          }
          
          try {
            currentItem = JSON.parse(decodeURIComponent(itemId));
            isExternalItem = true;
            
            if (!currentItem.title) {
              throw new Error('API item ba≈ülƒ±k bilgisi eksik');
            }
            
            console.log('‚úÖ External API Verisi Y√ºklendi:', currentItem);
            console.log('‚úÖ SourceId:', currentItem.sourceId);
          } catch (parseErr) {
            throw new Error(`API item parse hatasƒ±: ${parseErr.message}`);
          }
        } else {
          // Veritabanƒ±ndan gelen veri
          if (!itemId || isNaN(itemId)) {
            throw new Error(`Ge√ßersiz DB item ID: ${itemId}`);
          }
          
          const response = await fetch(`${API_URL}/${itemId}`);
          if (!response.ok) {
            throw new Error(`HTTP Hatasƒ±: ${response.status} - ƒ∞√ßerik bulunamadƒ±`);
          }
          
          currentItem = await response.json();
          isExternalItem = false;
          console.log('‚úÖ Veritabanƒ± Verisi Y√ºklendi:', currentItem);
        }
        
        renderItemDetail();
        
        // T√ºm itemler i√ßin yorumlarƒ± y√ºkle (DB ve API)
        loadComments();
        
        // T√ºm itemler i√ßin puanlarƒ± y√ºkle (DB ve API)
        loadRatings();
      } catch (error) {
        console.error('‚ùå loadItemDetails Hatasƒ±:', error);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
        document.getElementById('error').innerHTML = `
          <div style="padding: 20px; background: #fee; border: 1px solid #fcc; border-radius: 8px; color: #c33;">
            <h3>‚ö†Ô∏è ƒ∞√ßerik Y√ºklenirken Hata Olu≈ütu</h3>
            <p><strong>Hata:</strong> ${error.message}</p>
            <p><small style="color: #666;">
              L√ºtfen tarayƒ±cƒ±nƒ±n developer tools'unu (F12) a√ßƒ±p console'u kontrol edin.
            </small></p>
            <button onclick="window.history.back()" style="margin-top: 10px; padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">
              Geri D√∂n
            </button>
          </div>
        `;
      }
    }

    function renderItemDetail() {
      const item = currentItem;
      console.log('üé® renderItemDetail √ßaƒürƒ±ldƒ±:', { isExternalItem, itemSource, itemId, actualItemId: item?.id || item?.item_id, title: item?.title });
      console.log('üîç isExternalItem durumu:', isExternalItem, '| API mi:', itemSource === 'api');
      const rating = item.combined_rating || item.user_rating || item.external_rating || 0;
      const stars = renderStars(rating);

      const html = `
        <div class="detail-container" data-type="${item.item_type || ''}">
          <div class="detail-header item-header" data-type="${item.item_type || ''}">
            <div class="detail-cover">
              <img class="item-poster" src="${item.poster_url || 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22280%22 height=%22400%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22280%22 height=%22400%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2216%22 fill=%22%23999%22 text-anchor=%22middle%22 dy=%22.3em%22%3EG√∂rsel Yok%3C/text%3E%3C/svg%3E'}" 
                   alt="${item.title}" style="background-color: #f0f0f0;" onerror="this.style.backgroundColor='#f0f0f0'" />
              <span class="type-badge">${item.item_type === 'movie' ? 'üé¨ Film' : 'üìñ Kitap'}</span>
            </div>

            <div class="detail-info item-info">
              <h1>${item.title}</h1>
              ${isExternalItem ? `<span class="source-badge">üîó External API</span>` : ''}
              
              <div class="detail-meta">
                <div class="meta-item"><span class="meta-label">Yƒ±l:</span> ${item.year || 'Bilinmiyor'}</div>
                ${item.authors ? `<div class="meta-item"><span class="meta-label">Yazar:</span> ${item.authors}</div>` : ''}
                ${item.director ? `<div class="meta-item"><span class="meta-label">Y√∂netmen:</span> ${item.director}</div>` : ''}
                ${item.actors ? `<div class="meta-item"><span class="meta-label">Oyuncular:</span> ${item.actors}</div>` : ''}
                ${item.genres ? `<div class="meta-item"><span class="meta-label">T√ºr:</span> ${item.genres}</div>` : ''}
                ${item.page_count ? `<div class="meta-item"><span class="meta-label">Sayfa:</span> ${item.page_count}</div>` : ''}
              </div>

              <div class="rating-box">
                <div class="rating-display">
                  <div class="rating-big">${rating.toFixed(1)}</div>
                  <div class="rating-info">
                    <div class="rating-text">Platform Puanƒ±</div>
                    <div class="rating-text">${item.review_count || 0} Oy</div>
                    <div class="rating-stars">${stars}</div>
                  </div>
                </div>

                <div class="rating-input-group">
                  <label class="rating-label">Puan Ver:</label>
                  <div class="rating-stars-input" id="ratingInput"></div>
                  <button class="submit-btn" onclick="submitRating()">G√∂nder</button>
                </div>
              </div>

              <div class="action-buttons">
                ${item.item_type === 'book' ? `
                  <button class="action-btn" onclick="toggleLibrary('read')">üìö Okudum</button>
                  <button class="action-btn" onclick="toggleLibrary('toread')">üìñ Okunacak</button>
                ` : `
                  <button class="action-btn" onclick="toggleLibrary('watched')">üé¨ ƒ∞zledim</button>
                  <button class="action-btn" onclick="toggleLibrary('towatch')">‚è±Ô∏è ƒ∞zlenecek</button>
                `}
                <button class="action-btn secondary" onclick="addCustomList()">üìã √ñzel Listeye</button>
              </div>
            </div>
          </div>

          ${item.description ? `
            <div class="description-section">
              <div class="section-title">üìù √ñzet</div>
              <div class="description-text">${item.description}</div>
            </div>
          ` : ''}

          <div class="ratings-section">
            <div class="section-title">‚≠ê Puanlar</div>
            <div id="ratingsList" class="ratings-list"></div>
          </div>

          <div class="reviews-section" data-type="${item.item_type || ''}">
            <div class="section-title">üí¨ Yorumlar</div>
            
            <div class="review-form">
              <textarea id="commentText" placeholder="Yorumunuzu yazƒ±n..."></textarea>
              <button class="submit-btn" onclick="submitComment()">G√∂nder</button>
            </div>

            <div id="commentsList" class="comments-list"></div>
          </div>
        </div>
      `;

      document.getElementById('loading').style.display = 'none';
      document.getElementById('content').style.display = 'block';
      document.getElementById('content').innerHTML = html;

      initRatingInput();
    }

    function initRatingInput() {
      const container = document.getElementById('ratingInput');
      if (!container) return;
      
      container.innerHTML = '';
      for (let i = 1; i <= 10; i++) {
        const btn = document.createElement('button');
        btn.className = 'star-btn';
        btn.textContent = i <= 5 ? '‚≠ê' : '‚ú®';
        btn.onclick = () => selectRating(i);
        btn.style.animation = `slideInUp 0.4s ease ${0.1 + i * 0.05}s both`;
        container.appendChild(btn);
      }
    }

    function selectRating(rating) {
      selectedRating = rating;
      document.querySelectorAll('.star-btn').forEach((btn, idx) => {
        btn.classList.toggle('selected', idx < rating);
      });
    }

    function submitRating() {
      if (!selectedRating) {
        alert('L√ºtfen bir puan se√ßin');
        return;
      }
      
      // For API items, don't save to ratings table - ratings are saved as comments
      if (isExternalItem) {
        console.log('‚ö†Ô∏è API items i√ßin rating comments olarak kaydediliyor');
        saveRating(undefined, selectedRating); // No itemId for API items
      } else {
        // For DB items, use the item_id
        console.log('üìù DB item i√ßin rating kaydediliyor:', currentItem.item_id);
        saveRating(currentItem.item_id, selectedRating);
      }
    }

    async function saveRating(itemId, rating) {
      try {
        console.log(`‚≠ê Puan kaydediliyor: ${rating}/10, itemId: ${itemId}, currentUser:`, currentUser);
        
        if (isExternalItem) {
          // API item - ratings endpoint'ine g√∂nder (yeni endpoint)
          let sourceId;
          
          if (currentItem.external_api_source && currentItem.external_api_id) {
            sourceId = `${currentItem.external_api_source}_${currentItem.external_api_id}`;
          } else if (currentItem.external_api_id) {
            sourceId = `external_${currentItem.external_api_id}`;
          } else {
            console.error('‚ùå external_api_id bulunamadƒ±:', currentItem);
            alert('‚ùå API item bilgisi eksik');
            return;
          }
          
          console.log(`üì§ API Puanƒ± Kaydediliyor (Ratings): ${sourceId} -> ${rating}/10`);
          
          // Title'ƒ±n g√ºvenli ≈üekilde g√∂nderilmesi
          if (!currentItem.title || currentItem.title.trim() === '' || currentItem.title === 'Unknown') {
            alert('‚ùå Hata: ƒ∞√ßeriƒüin ba≈ülƒ±ƒüƒ± alƒ±namadƒ±. L√ºtfen sayfayƒ± yenileyin.');
            return;
          }
          
          const response = await fetch(`${API_BASE}/items/api/rating/${sourceId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              user_id: currentUser.user_id,
              rating: rating,
              title: currentItem.title,
              item_type: currentItem.item_type || "movie",
              poster_url: currentItem.poster_url || "",
              year: currentItem.year || null,
              description: currentItem.description || ""
            })
          });

          if (response.ok) {
            const data = await response.json();
            console.log('‚úÖ API Puanƒ± ba≈üarƒ±yla kaydedildi:', data);
            alert(`‚úÖ ${rating}/10 puan ba≈üarƒ±yla kaydedildi!`);
            selectedRating = 0;
            initRatingInput();
            
            // API item'ƒ±n g√ºncel verilerini √ßek ve render et
            try {
              const sourceId = `${currentItem.external_api_source}_${currentItem.external_api_id}`;
              const updatedResponse = await fetch(`${API_URL}/api/${sourceId}`);
              if (updatedResponse.ok) {
                const updatedItem = await updatedResponse.json();
                console.log('‚úÖ API Item g√ºncel verisi y√ºklendi:', updatedItem);
                currentItem = updatedItem;
                renderItemDetail();
                loadRatings();
              }
            } catch (updateErr) {
              console.error('‚ö†Ô∏è API item g√ºncellemesi ba≈üarƒ±sƒ±z, yeniden y√ºkleniyor:', updateErr);
              setTimeout(() => loadItemDetails(), 500);
            }
          } else {
            const errorText = await response.text();
            console.error('‚ùå API Puan kayƒ±t hatasƒ±:', response.status, errorText);
            alert(`‚ùå Puan kaydedilirken hata olu≈ütu: ${response.status}`);
          }
        } else {
          // DB item - normal endpoint
          console.log(`üì§ DB Puanƒ± Kaydediliyor: /items/${itemId}/rate`);
          const response = await fetch(`${API_URL}/${itemId}/rate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              user_id: currentUser.user_id,
              rating: rating
            })
          });

          if (response.ok) {
            const data = await response.json();
            console.log('‚úÖ Puan ba≈üarƒ±yla kaydedildi:', data);
            alert(`‚úÖ ${rating}/10 puan ba≈üarƒ±yla kaydedildi!`);
            selectedRating = 0;
            initRatingInput();
            setTimeout(() => loadItemDetails(), 500);
          } else {
            const errorText = await response.text();
            console.error('‚ùå Puan kayƒ±t hatasƒ±:', response.status, errorText);
            alert('‚ùå Puan kaydedilirken hata olu≈ütu');
          }
        }
      } catch (error) {
        console.error('‚ùå Rating hatasƒ±:', error);
        alert('‚ùå Puan kaydedilirken hata olu≈ütu');
      }
    }

    function toggleLibrary(action) {
      console.log(`üìö ${action} i≈ülemi:`, 'isExternalItem:', isExternalItem);
      
      // Status'u action'dan derive et
      let status;
      if (currentItem.item_type === 'book') {
        status = action === 'read' ? 'read' : 'toread';
      } else {
        status = action === 'watched' ? 'watched' : 'towatch';
      }
      
      try {
        if (isExternalItem) {
          // API item - API library endpoint'ini kullan
          let sourceId = currentItem.sourceId;
          
          if (!sourceId) {
            if (currentItem.source === 'tmdb') {
              sourceId = `tmdb_${currentItem.id || currentItem.external_api_id}`;
            } else if (currentItem.source === 'google_books') {
              sourceId = `google_books_${currentItem.id || currentItem.external_api_id}`;
            } else if (currentItem.source === 'openlib') {
              sourceId = `openlib_${currentItem.id || currentItem.external_api_id}`;
            }
          }
          
          const payload = {
            user_id: currentUser.user_id,
            status: status,
            action: 'add',
            title: currentItem.title,
            item_type: currentItem.item_type,
            poster_url: currentItem.poster_url || currentItem.posterUrl,
            year: currentItem.year || currentItem.releaseDate?.split('-')[0],
            description: currentItem.description || currentItem.overview
          };
          
          console.log(`üì§ API K√ºt√ºphaneye ekleniyor:`, sourceId, payload);
          
          fetch(`${API_URL}/api/library/${sourceId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              alert(`‚úÖ ${action} i≈ülemi ba≈üarƒ±lƒ±!`);
              console.log(`‚úÖ API ƒ∞√ßeriƒüi K√ºt√ºphaneye Eklendi:`, data);
            } else {
              alert(`‚ùå Hata: ${data.detail || 'Bilinmeyen hata'}`);
            }
          })
          .catch(err => {
            console.error('‚ùå API K√ºt√ºphane hatasƒ±:', err);
            alert('‚ùå ƒ∞≈ülem sƒ±rasƒ±nda hata olu≈ütu');
          });
        } else {
          // DB item - normal endpoint
          const payload = {
            user_id: currentUser.user_id,
            status: status,
            action: 'add'
          };
          
          console.log(`üì§ DB K√ºt√ºphaneye ekleniyor:`, currentItem.item_id, payload);
          
          fetch(`${API_URL}/${currentItem.item_id}/library`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              alert(`‚úÖ ${action} i≈ülemi ba≈üarƒ±lƒ±!`);
              console.log(`‚úÖ DB ƒ∞√ßeriƒüi K√ºt√ºphaneye Eklendi:`, data);
            } else {
              alert(`‚ùå Hata: ${data.detail || 'Bilinmeyen hata'}`);
            }
          })
          .catch(err => {
            console.error('‚ùå DB K√ºt√ºphane hatasƒ±:', err);
            alert('‚ùå ƒ∞≈ülem sƒ±rasƒ±nda hata olu≈ütu');
          });
        }
      } catch (err) {
        console.error('‚ùå Hata:', err);
        alert('‚ùå ƒ∞≈ülem ba≈üarƒ±sƒ±z');
      }
    }

    let currentListSort = 'recent'; // Default sort: recently created first

    async function addCustomList() {
      console.log('üìã √ñzel listeye ekle - Modal a√ßƒ±lƒ±yor');
      
      try {
        // Kullanƒ±cƒ±nƒ±n √∂zel listelerini getir
        const response = await fetch(`${API_URL}/custom-lists/${currentUser.user_id}`);
        const data = await response.json();
        
        const existingListsDiv = document.getElementById('existingLists');
        
        if (!data.success || !data.lists || data.lists.length === 0) {
          // √ñzel liste yoksa, yeni liste olu≈ütur formu g√∂ster
          existingListsDiv.innerHTML = `
            <div class="empty-lists">
              <p>üì≠ Hen√ºz hi√ß √∂zel liste yok</p>
              <p style="font-size: 12px; color: #bbb;">A≈üaƒüƒ±da yeni bir liste olu≈üturun</p>
            </div>
          `;
          showNewListForm();
        } else {
          // Listeleri sƒ±rala
          let sortedLists = [...data.lists];
          
          if (currentListSort === 'recent') {
            // En yeni olu≈üturulanlar √∂nce
            sortedLists.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
          }
          
          // Mevcut listeleri g√∂ster
          let listHtml = '';
          sortedLists.forEach((lst) => {
            const description = lst.description ? `<div class="list-item-description">${lst.description}</div>` : '';
            listHtml += `
              <div class="list-item" onclick="addItemToList(${lst.list_id}, '${lst.name.replace(/'/g, "\\'")}')">
                <div style="flex: 1;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                    <span class="list-item-name">${lst.name}</span>
                    <span class="list-item-count">üì¶ ${lst.item_count} item</span>
                  </div>
                  ${description}
                </div>
                <button class="list-delete-btn" onclick="event.stopPropagation(); deleteCustomList(${lst.list_id}, '${lst.name.replace(/'/g, "\\'")}')" title="Listeyi sil">üóëÔ∏è</button>
              </div>
            `;
          });
          
          // Sorting controls ekle
          const sortingControls = `
            <div class="list-sorting-controls">
              <button class="sort-btn ${currentListSort === 'recent' ? 'active' : ''}" onclick="changeListSort('recent')" title="En yeni olu≈üturulanlar">üïê Son Eklenenler</button>

            </div>
          `;
          
          existingListsDiv.innerHTML = sortingControls + listHtml + `
            <button class="new-list-btn" onclick="showNewListForm()">+ Yeni Liste Olu≈ütur</button>
          `;
        }
        
        // Modal'ƒ± a√ß
        document.getElementById('listModal').classList.add('active');
      } catch (err) {
        console.error('‚ùå √ñzel liste hatasƒ±:', err);
        alert('‚ùå Liste y√ºklenirken hata olu≈ütu');
      }
    }

    function changeListSort(sortType) {
      currentListSort = sortType;
      addCustomList(); // Listeyi yeniden y√ºkle
    }

    function showNewListForm() {
      document.getElementById('existingLists').style.display = 'none';
      document.getElementById('newListForm').style.display = 'block';
      document.getElementById('newListName').value = '';
      document.getElementById('newListDescription').value = '';
      setTimeout(() => document.getElementById('newListName').focus(), 100);
    }

    function cancelNewList() {
      document.getElementById('newListForm').style.display = 'none';
      document.getElementById('existingLists').style.display = 'block';
      document.getElementById('newListName').value = '';
      document.getElementById('newListDescription').value = '';
    }

    function handleEnter(event) {
      if (event.key === 'Enter') {
        createNewList();
      }
    }

    async function createNewList() {
      const newListName = document.getElementById('newListName').value.trim();
      const newListDescription = document.getElementById('newListDescription').value.trim();
      
      if (!newListName) {
        alert('‚ùå Liste adƒ± bo≈ü bƒ±rakƒ±lamaz');
        return;
      }
      
      try {
        // Yeni liste olu≈ütur
        const createResponse = await fetch(`${API_URL}/custom-lists`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_id: currentUser.user_id,
            name: newListName,
            description: newListDescription
          })
        });
        
        const createData = await createResponse.json();
        if (createData.success) {
          const listId = createData.list_id;
          
          // Item'i listeye ekle
          await addItemToList(listId, newListName);
        } else {
          alert(`‚ùå Hata: ${createData.detail || 'Liste olu≈üturulamadƒ±'}`);
        }
      } catch (err) {
        console.error('‚ùå Liste olu≈üturma hatasƒ±:', err);
        alert('‚ùå Liste olu≈üturulurken hata olu≈ütu');
      }
    }

    async function addItemToList(listId, listName) {
      try {
        let itemIdToAdd = null;
        let sourceIdToAdd = null;
        
        if (isExternalItem) {
          // API itemi i√ßin source_id olu≈ütur
          if (currentItem.source === 'tmdb') {
            sourceIdToAdd = `tmdb_${currentItem.id || currentItem.external_api_id}`;
          } else if (currentItem.source === 'google_books') {
            sourceIdToAdd = `google_books_${currentItem.id || currentItem.external_api_id}`;
          } else if (currentItem.source === 'openlib') {
            sourceIdToAdd = `openlib_${currentItem.id || currentItem.external_api_id}`;
          }
        } else {
          // DB itemi i√ßin item_id
          itemIdToAdd = currentItem.item_id;
        }
        
        // Item'i listeye ekle
        const addResponse = await fetch(`${API_URL}/custom-lists/${listId}/items`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            item_id: itemIdToAdd,
            source_id: sourceIdToAdd,
            action: 'add',
            // API items i√ßin metadata ekle
            title: currentItem.title,
            item_type: currentItem.item_type || currentItem.type || 'movie',
            poster_url: currentItem.poster_url || currentItem.posterUrl || currentItem.poster_path,
            year: currentItem.year || currentItem.releaseDate?.split('-')[0] || currentItem.publishedDate?.split('-')[0],
            description: currentItem.description || currentItem.overview || ''
          })
        });
        
        const addData = await addResponse.json();
        if (addData.success) {
          alert(`‚úÖ "${listName}" listesine eklendi!`);
          closeListModal();
          console.log(`‚úÖ Listeye eklendi:`, addData);
        } else {
          alert(`‚ùå Hata: ${addData.detail || 'Bilinmeyen hata'}`);
        }
      } catch (err) {
        console.error('‚ùå Item ekleme hatasƒ±:', err);
        alert('‚ùå Item eklenirken hata olu≈ütu');
      }
    }

    async function deleteCustomList(listId, listName) {
      if (!confirm(`"${listName}" listesini silmek istediƒüinizden emin misiniz?`)) {
        return;
      }

      try {
        const response = await fetch(`${API_URL}/custom-lists/${listId}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();
        if (data.success) {
          alert(`‚úÖ "${listName}" listesi silindi`);
          // Modal'ƒ± kapata ve yenile
          closeListModal();
          // Listeyi tekrar g√∂ster
          setTimeout(() => addCustomList(), 500);
        } else {
          alert(`‚ùå Hata: ${data.detail || 'Liste silinemedi'}`);
        }
      } catch (err) {
        console.error('‚ùå Liste silme hatasƒ±:', err);
        alert('‚ùå Liste silinirken hata olu≈ütu');
      }
    }

    async function deleteCustomList(listId, listName) {
      if (!confirm(`"${listName}" listesini silmek istediƒüinizden emin misiniz?`)) {
        return;
      }

      try {
        const response = await fetch(`${API_URL}/custom-lists/${listId}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();
        if (data.success) {
          alert(`‚úÖ "${listName}" listesi silindi!`);
          // Modal'ƒ± yenile
          addCustomList();
        } else {
          alert(`‚ùå Hata: ${data.detail || 'Liste silinemedi'}`);
        }
      } catch (err) {
        console.error('‚ùå Liste silme hatasƒ±:', err);
        alert('‚ùå Liste silinirken hata olu≈ütu');
      }
    }

    function closeListModal() {
      document.getElementById('listModal').classList.remove('active');
      document.getElementById('newListForm').style.display = 'none';
      document.getElementById('existingLists').style.display = 'block';
      document.getElementById('newListName').value = '';
      document.getElementById('newListDescription').value = '';
    }

    async function loadComments() {
      try {
        let comments = [];
        
        if (isExternalItem) {
          // API items i√ßin comment API'sini √ßaƒüƒ±r - sourceId'yi kullan
          let sourceId = currentItem.sourceId;
          
          // sourceId yoksa olu≈ütur
          if (!sourceId) {
            const apiSource = currentItem.external_api_source || currentItem.source;
            const apiId = currentItem.external_api_id || currentItem.id;
            
            if (apiSource && apiId) {
              sourceId = `${apiSource}_${apiId}`;
            }
          }
          
          if (!sourceId || sourceId.includes('undefined')) {
            console.log('‚ö†Ô∏è SourceId olu≈üturulamadƒ±:', { currentItem, sourceId });
            renderComments([]);
            return;
          }
          
          console.log(`üì• API Yorumlarƒ±nƒ± √áekiliyor: ${sourceId}`);
          const response = await fetch(`${API_BASE}/items/api/comments/${sourceId}`);
          
          if (!response.ok) {
            console.error(`‚ùå API Yanƒ±t Hatasƒ±: ${response.status}`);
            renderComments([]);
            return;
          }
          
          const data = await response.json();
          console.log(`üìä API Response:`, data);
          
          comments = data.comments || [];
          console.log(`‚úÖ API Yorumlarƒ± (${sourceId}): ${comments.length} bulundu`);
        } else {
          // DB items i√ßin normal endpoint
          console.log(`üì• DB Yorumlarƒ±nƒ± √áekiliyor: /items/${currentItem.item_id}/comments`);
          const response = await fetch(`${API_URL}/${currentItem.item_id}/comments`);
          
          if (!response.ok) {
            console.error('‚ùå DB Yanƒ±t Hatasƒ±:', response.status);
            renderComments([]);
            return;
          }
          
          comments = await response.json();
          console.log(`‚úÖ DB Yorumlarƒ± (${currentItem.item_id}): ${comments.length} bulundu`);
        }
        
        renderComments(comments);
      } catch (error) {
        console.error('‚ùå Yorumlar Y√ºklenirken Hata:', error);
        renderComments([]);
      }
    }

    function renderComments(comments) {
      const container = document.getElementById('commentsList');
      console.log('üé® renderComments √ßaƒürƒ±ldƒ±:', { 
        containerExists: !!container, 
        commentsLength: comments?.length,
        comments: comments 
      });
      
      if (!container) {
        console.error('‚ùå commentsList container bulunamadƒ±!');
        return;
      }
      
      // Oy sayƒ±sƒ±nƒ± g√ºncelle
      const ratingCount = comments ? comments.length : 0;
      const ratingCountEl = document.querySelector('.rating-text:nth-of-type(2)');
      if (ratingCountEl) {
        ratingCountEl.textContent = `${ratingCount} Oy`;
      }
      
      if (!comments || !comments.length) {
        const emptyMsg = isExternalItem 
          ? 'Bu i√ßerik i√ßin hen√ºz yorum yok' 
          : 'Hen√ºz yorum yok. ƒ∞lk yorum yapan siz olun!';
        container.innerHTML = `<div class="empty-state">${emptyMsg}</div>`;
        console.log('‚ÑπÔ∏è Bo≈ü yorum mesajƒ± g√∂steriliyor');
        return;
      }
      
      console.log('‚úÖ Yorumlar render ediliyor:', comments.length);

      container.innerHTML = comments.map((comment, idx) => {
        const author = comment.username || comment.author || 'Anonim';
        const text = comment.content || comment.review_text || comment.text || '';
        const date = comment.created_at || comment.date || '';
        const rating = comment.rating || 0;
        
        return `
          <div class="comment-item" style="animation: slideInLeft 0.4s ease ${0.1 + idx * 0.05}s both;">
            <div class="comment-header">
              <div style="flex: 1; display: flex; align-items: center; gap: 10px;">
                ${comment.avatar_url ? `<img src="${comment.avatar_url}" alt="${author}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">` : `<div style="width: 32px; height: 32px; border-radius: 50%; background: #667eea; display: flex; align-items: center; justify-content: center; color: white; font-size: 16px;">üë§</div>`}
                <a href="./profile.html?user=${comment.user_id}" style="text-decoration: none; color: #667eea; font-weight: 500; cursor: pointer;" title="Profili ziyaret et">${author}</a>
                ${rating ? `<span style="margin-left: auto; color: #ff9800;">‚≠ê ${rating}/10</span>` : ''}
              </div>
              <span class="comment-date">${date ? formatDate(date) : 'üåê API'}</span>
            </div>
            <div class="comment-text">${text}</div>
            ${comment.review_id && parseInt(comment.user_id) === parseInt(currentUser.user_id) ? `
              <div class="comment-actions">
                <button class="comment-btn" data-review-id="${comment.review_id}" data-comment-text="${text.replace(/"/g, '&quot;')}" onclick="editComment(this)">‚úèÔ∏è D√ºzenle</button>
                <button class="comment-btn" onclick="deleteComment(${comment.review_id})">üóëÔ∏è Sil</button>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    async function loadRatings() {
      try {
        let ratingsUrl;
        
        if (isExternalItem) {
          // API item - source_id ile ratings √ßek
          if (!currentItem.external_api_source || !currentItem.external_api_id) {
            console.log('‚ö†Ô∏è API item bilgisi eksik, ratings y√ºklenemedi');
            renderRatings([]);
            return;
          }
          
          const sourceId = `${currentItem.external_api_source}_${currentItem.external_api_id}`;
          ratingsUrl = `${API_URL}/api/ratings/${sourceId}`;
          console.log(`üì• API Puanlarƒ± √áekiliyor: ${ratingsUrl}`);
        } else {
          // DB item - item_id ile ratings √ßek
          if (!currentItem.item_id) {
            console.log('‚ö†Ô∏è item_id bulunamadƒ±, ratings y√ºklenemedi');
            renderRatings([]);
            return;
          }
          
          ratingsUrl = `${API_URL}/${currentItem.item_id}/ratings`;
          console.log(`üì• Puanlarƒ± √áekiliyor: ${ratingsUrl}`);
        }
        
        const response = await fetch(ratingsUrl);
        
        if (!response.ok) {
          console.error('‚ùå Puanlar Yanƒ±t Hatasƒ±:', response.status);
          renderRatings([]);
          return;
        }
        
        const ratings = await response.json();
        console.log(`‚úÖ Puanlar: ${ratings.length} bulundu`, ratings);
        
        renderRatings(ratings);
      } catch (error) {
        console.error('‚ùå Puanlar Y√ºklenirken Hata:', error);
        renderRatings([]);
      }
    }

    function renderRatings(ratings) {
      const container = document.getElementById('ratingsList');
      if (!container) return;
      
      if (!ratings || !ratings.length) {
        container.innerHTML = `<div class="empty-state">Bu i√ßerik i√ßin hen√ºz puan yok. Siz ilk puanƒ± verin!</div>`;
        return;
      }

      container.innerHTML = ratings.map((rating, idx) => {
        const stars = '‚≠ê'.repeat(Math.floor(rating.score / 2)) + (rating.score % 2 !== 0 ? '‚ú®' : '');
        const date = rating.created_at || '';
        const isOwnRating = rating.user_id === currentUser.user_id;
        
        return `
          <div class="rating-item" style="animation: slideInLeft 0.4s ease ${0.1 + idx * 0.05}s both;">
            <div class="rating-item-header">
              <div style="flex: 1; display: flex; align-items: center; gap: 10px;">
                ${rating.avatar_url ? `<img src="${rating.avatar_url}" alt="${rating.username}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">` : `<div style="width: 32px; height: 32px; border-radius: 50%; background: #667eea; display: flex; align-items: center; justify-content: center; color: white; font-size: 16px;">üë§</div>`}
                <a href="./profile.html?user=${rating.user_id}" style="text-decoration: none; color: #667eea; font-weight: 500; cursor: pointer;" title="Profili ziyaret et">${rating.username || 'Anonim'}</a>
                <span style="margin-left: auto; color: #ff9800; font-size: 18px;">${stars} <strong>${rating.score}/10</strong></span>
              </div>
              <span class="rating-date">${date ? formatDate(date) : ''}</span>
            </div>
            ${isOwnRating ? `
              <div class="rating-actions">
                <button class="comment-btn" onclick="deleteRating(${rating.rating_id}, ${currentItem.item_id})">üóëÔ∏è Sil</button>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    async function deleteRating(ratingId, itemId) {
      if (confirm('Bu puanƒ± silmek istediƒüinize emin misiniz?')) {
        try {
          console.log(`üóëÔ∏è Puan siliniyor: ${ratingId}`);
          const response = await fetch(`${API_URL}/rating/${ratingId}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
          });

          if (response.ok) {
            const data = await response.json();
            console.log('‚úÖ Puan silindi:', data);
            alert('‚úÖ Puan silindi');
            loadRatings(); // Puanlarƒ± yenile
            setTimeout(() => loadItemDetails(), 500);
          } else {
            const error = await response.text();
            console.error('‚ùå Puan silme hatasƒ±:', response.status, error);
            alert(`‚ùå Hata: ${error || 'Puan silinemedi'}`);
          }
        } catch (error) {
          console.error('‚ùå Puan silme hatasƒ±:', error);
          alert('‚ùå Puan silinirken hata olu≈ütu');
        }
      }
    }

    function editComment(button) {
      const reviewId = button.getAttribute('data-review-id');
      const currentText = button.getAttribute('data-comment-text');
      const newText = prompt('Yorumu d√ºzenle:', currentText);
      if (newText !== null && newText.trim()) {
        performEditComment(reviewId, newText.trim());
      }
    }

    async function submitComment() {
      const text = document.getElementById('commentText')?.value.trim();
      if (!text) {
        alert('L√ºtfen bir yorum yazƒ±n');
        return;
      }

      if (isExternalItem) {
        // API items i√ßin comment POST
        try {
          // Title'ƒ±n g√ºvenli ≈üekilde kontrol edilmesi
          if (!currentItem.title || currentItem.title.trim() === '' || currentItem.title === 'Unknown') {
            alert('‚ùå Hata: ƒ∞√ßeriƒüin ba≈ülƒ±ƒüƒ± alƒ±namadƒ±. L√ºtfen sayfayƒ± yenileyin.');
            return;
          }
          
          let sourceId = currentItem.sourceId;
          
          // sourceId yoksa olu≈ütur
          if (!sourceId) {
            const apiSource = currentItem.external_api_source || currentItem.source;
            const apiId = currentItem.external_api_id || currentItem.id;
            
            if (apiSource && apiId) {
              sourceId = `${apiSource}_${apiId}`;
            }
          }
          
          const response = await fetch(`${API_BASE}/items/api/comments/${sourceId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              user_id: currentUser.user_id,
              review_text: text,
              rating: selectedRating || null,
              // API item metadata ekle
              title: currentItem.title,
              item_type: currentItem.item_type || currentItem.type || 'movie',
              poster_url: currentItem.poster_url || currentItem.posterUrl || currentItem.poster_path,
              year: currentItem.year || currentItem.releaseDate?.split('-')[0] || currentItem.publishedDate?.split('-')[0],
              description: currentItem.description || currentItem.overview || ''
            })
          });

          if (response.ok) {
            document.getElementById('commentText').value = '';
            selectedRating = 0;
            await loadComments(); // √ñnce yorumlarƒ± y√ºkle
            alert('Yorum ba≈üarƒ±yla eklendi!');
          } else {
            const error = await response.text();
            console.error('‚ùå API Yorum Ekleme Hatasƒ±:', response.status, error);
            alert(`Hata: ${error || 'Yorum eklenirken hata olu≈ütu'}`);
          }
        } catch (error) {
          console.error('Yorum ekleme hatasƒ±:', error);
          alert('Yorum eklenirken hata olu≈ütu');
        }
      } else {
        // DB items i√ßin normal comment POST
        try {
          const response = await fetch(`${API_URL}/${currentItem.item_id}/comments`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              user_id: currentUser.user_id,
              item_id: currentItem.item_id,
              review_text: text,
              rating: null
            })
          });

          if (response.ok) {
            document.getElementById('commentText').value = '';
            await loadComments(); // √ñnce yorumlarƒ± y√ºkle
            alert('Yorum ba≈üarƒ±yla eklendi!');
          } else {
            const error = await response.text();
            console.error('‚ùå Yorum Ekleme Hatasƒ±:', response.status, error);
            alert(`Hata: ${error || 'Yorum eklenirken hata olu≈ütu'}`);
          }
        } catch (error) {
          console.error('Yorum ekleme hatasƒ±:', error);
          alert('Yorum eklenirken hata olu≈ütu');
        }
      }
    }

    function deleteComment(reviewId) {
      if (confirm('Yorumu silmek istediƒüinize emin misiniz?')) {
        performDeleteComment(reviewId);
      }
    }

    async function performDeleteComment(reviewId) {
      try {
        const response = await fetch(`${API_BASE}/reviews/${reviewId}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' }
        });

        if (response.ok) {
          const data = await response.json();
          alert('‚úÖ Yorum silindi');
          loadComments(); // Yorum listesini yenile
        } else {
          const error = await response.text();
          alert(`‚ùå Hata: ${error || 'Yorum silinemedi'}`);
        }
      } catch (error) {
        console.error('‚ùå Yorum silme hatasƒ±:', error);
        alert('‚ùå Yorum silinirken hata olu≈ütu');
      }
    }

    async function performEditComment(reviewId, newText) {
      try {
        const response = await fetch(`${API_BASE}/reviews/${reviewId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            review_text: newText
          })
        });

        if (response.ok) {
          const data = await response.json();
          alert('‚úÖ Yorum g√ºncelle≈ütirildi');
          loadComments(); // Yorum listesini yenile
        } else {
          const error = await response.text();
          alert(`‚ùå Hata: ${error || 'Yorum g√ºncelle≈ütirilemedi'}`);
        }
      } catch (error) {
        console.error('‚ùå Yorum g√ºncelleme hatasƒ±:', error);
        alert('‚ùå Yorum g√ºncellenirken hata olu≈ütu');
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      if (!itemId) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
        document.getElementById('error').innerHTML = '‚ùå ƒ∞√ßerik se√ßilmedi';
        return;
      }
      loadItemDetails();
    });
  </script>
</body>
</html>