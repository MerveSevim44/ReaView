<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ke≈üfet ‚Ä¢ BiblioNet</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #f8f9fa;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }

    main {
      padding: 40px 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      color: #667eea;
      margin-bottom: 30px;
      font-size: 32px;
      font-weight: 700;
    }

    h2 {
      color: #333;
      margin-top: 50px;
      margin-bottom: 20px;
      font-size: 24px;
      font-weight: 600;
    }

    /* ============ ARAMA B√ñL√úM√ú ============ */
    .search-section {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 40px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .search-box {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .search-box input {
      flex: 1;
      padding: 14px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s ease;
    }

    .search-box input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .search-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
    }

    .search-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .search-btn:active {
      transform: translateY(0);
    }

    /* ============ Fƒ∞LTRELEME B√ñL√úM√ú ============ */
    .filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
    }

    .filter-group label {
      font-size: 12px;
      color: #666;
      margin-bottom: 6px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .filter-group select,
    .filter-group input {
      padding: 10px 12px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      background: white;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .filter-group select:focus,
    .filter-group input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
    }

    .filter-group select {
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 20px;
      padding-right: 35px;
    }

    .clear-filters {
      align-self: flex-end;
      margin-top: 15px;
      background: #f0f0f0;
      color: #666;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .clear-filters:hover {
      background: #e0e0e0;
      color: #333;
    }

    /* ============ SONU√áLAR GRID'ƒ∞ ============ */
    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 30px;
    }

    .result-card {
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .result-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 14px rgba(102, 126, 234, 0.15);
    }

    .result-card-image {
      width: 100%;
      height: 180px;
      overflow: hidden;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      position: relative;
    }

    .result-card-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }

    .result-card:hover .result-card-image img {
      transform: scale(1.05);
    }

    .result-card-image .type-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .result-card-info {
      padding: 12px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .result-card-title {
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
      font-size: 13px;
      line-height: 1.3;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .result-card-meta {
      font-size: 11px;
      color: #999;
      margin-bottom: 8px;
    }

    .result-card-rating {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 10px;
      font-size: 12px;
    }

    .rating-stars {
      color: #ffc107;
      letter-spacing: 2px;
    }

    .result-card-buttons {
      display: flex;
      gap: 6px;
      margin-top: auto;
    }

    .result-card-btn {
      flex: 1;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 8px;
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .result-card-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .result-card-btn.info {
      background: #f0f0f0;
      color: #333;
    }

    .result-card-btn.info:hover {
      background: #e0e0e0;
    }

    /* ============ DURUM MESAJLARI ============ */
    .loading {
      text-align: center;
      color: #999;
      padding: 60px 20px;
      font-size: 16px;
    }

    .loading::after {
      content: '';
      display: inline-block;
      width: 20px;
      height: 20px;
      margin-left: 10px;
      border: 3px solid #f0f0f0;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 20px;
    }

    .auth-message {
      background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
      border: 1px solid #667eea30;
      color: #333;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      margin-bottom: 30px;
    }

    .auth-message h3 {
      color: #667eea;
      margin-bottom: 10px;
    }

    .auth-message a {
      color: #667eea;
      text-decoration: none;
      font-weight: 600;
      display: inline-block;
      margin-top: 10px;
      padding: 8px 16px;
      background: #667eea;
      color: white;
      border-radius: 6px;
      transition: all 0.3s ease;
    }

    .auth-message a:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    /* ============ RESPONSIVE ============ */
    @media (max-width: 768px) {
      main {
        padding: 20px 15px;
      }

      h1 {
        font-size: 24px;
        margin-bottom: 20px;
      }

      .search-box {
        flex-direction: column;
      }

      .search-btn {
        width: 100%;
      }

      .filters {
        grid-template-columns: 1fr;
      }

      .results-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      }
    }
  </style>
</head>
<body>
  <!-- Navbar otomatik olarak eklenecek -->

  <main id="main-content">
    <h1>üîç Ke≈üfet</h1>
    
    <!-- ARAMA B√ñL√úM√ú -->
    <div class="search-section">
      <div class="search-box">
        <input 
          type="text" 
          id="searchInput" 
          placeholder="Film, kitap, y√∂netmen, yazar ara..." 
        />
        <button class="search-btn" id="searchBtn">üîç Ara</button>
      </div>

      <!-- GELƒ∞≈ûMƒ∞≈û Fƒ∞LTRELEME -->
      <div class="filters">
        <div class="filter-group">
          <label for="filterType">T√ºr</label>
          <select id="filterType">
            <option value="">T√ºm√º</option>
            <option value="movie">üé¨ Film</option>
            <option value="book">üìñ Kitap</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="filterYear">Yƒ±l</label>
          <input 
            type="number" 
            id="filterYear" 
            placeholder="√ñrn: 2024"
            min="1900"
            max="2100"
          />
        </div>

        <div class="filter-group">
          <label for="filterRating">Minimum Puan</label>
          <select id="filterRating">
            <option value="">Herhangi</option>
            <option value="8">‚≠ê 8.0+</option>
            <option value="7">‚≠ê 7.0+</option>
            <option value="6">‚≠ê 6.0+</option>
            <option value="5">‚≠ê 5.0+</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="sortBy">Sƒ±rala</label>
          <select id="sortBy">
            <option value="relevance">Uygunluk</option>
            <option value="rating">Puana G√∂re</option>
            <option value="popularity">Pop√ºlarite</option>
            <option value="newest">En Yeni</option>
          </select>
        </div>

        <button class="clear-filters" id="clearFilters">Filtreleri Temizle</button>
      </div>
    </div>

    <!-- ARAMA SONU√áLARI -->
    <div id="resultsContainer" class="results-grid">
      <div class="empty-state">
        <div class="empty-state-icon">üîç</div>
        <p>Aramaya ba≈ülamak i√ßin yukarƒ±ya bir ≈üey yazƒ±n ve Ara butonuna tƒ±klayƒ±n</p>
      </div>
    </div>

    <!-- B√ñL√úM 1: EN Y√úKSEK PUANLILAN √úR√úNLER (VITRIN) -->
    <h2>‚≠ê En Y√ºksek Puanlƒ±lar</h2>
    <div id="topRatedContainer" class="results-grid">
      <div class="loading">Y√ºkleniyor...</div>
    </div>

    <!-- B√ñL√úM 2: EN POP√úLER √úR√úNLER (VITRIN) -->
    <h2>üî• En Pop√ºlerler</h2>
    <div id="mostPopularContainer" class="results-grid">
      <div class="loading">Y√ºkleniyor...</div>
    </div>
  </main>

  <!-- Load Navbar Module -->
  <script type="module" src="./js/components/navbar.js"></script>

  <!-- Search & Browse Logic -->
  <script type="module">
    import { sessionManager } from "./js/core/session-manager.js";

    const API_BASE = "http://127.0.0.1:8000";
    const API_URL = `${API_BASE}/items`;
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const resultsContainer = document.getElementById('resultsContainer');
    const topRatedContainer = document.getElementById('topRatedContainer');
    const mostPopularContainer = document.getElementById('mostPopularContainer');
    const clearFiltersBtn = document.getElementById('clearFilters');
    
    const filterType = document.getElementById('filterType');
    const filterYear = document.getElementById('filterYear');
    const filterRating = document.getElementById('filterRating');
    const sortBy = document.getElementById('sortBy');

    // ============ SESSION STORAGE: ARAMA SONU√áLARINƒ± KAYDET ============
    const STORAGE_KEY = 'searchState';
    const ITEMS_STORAGE_KEY = 'searchItems';
    
    const saveSearchState = () => {
      const state = {
        query: searchInput.value,
        results: resultsContainer.innerHTML,
        filterType: filterType.value,
        filterYear: filterYear.value,
        filterRating: filterRating.value,
        sortBy: sortBy.value
      };
      sessionStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      console.log('üíæ Arama durumu kaydedildi:', state.query);
    };

    const restoreSearchState = () => {
      const saved = sessionStorage.getItem(STORAGE_KEY);
      if (saved) {
        try {
          const state = JSON.parse(saved);
          searchInput.value = state.query;
          resultsContainer.innerHTML = state.results;
          filterType.value = state.filterType;
          filterYear.value = state.filterYear;
          filterRating.value = state.filterRating;
          sortBy.value = state.sortBy;
          console.log('üìÇ Arama durumu geri y√ºklendi:', state.query);
        } catch (e) {
          console.error('Arama durumu geri y√ºklemesi ba≈üarƒ±sƒ±z:', e);
        }
      }
    };

    // Sayfa y√ºklendiƒüinde √∂nceki arama sonu√ßlarƒ±nƒ± geri y√ºkle
    window.addEventListener('load', restoreSearchState);

    // ============ RENDER HELPER ============
    // Global items array - API items i√ßin index ref
    let currentItems = [];

    const renderResults = (items, container) => {
      console.log('üé® renderResults √ßaƒürƒ±ldƒ±:', { itemsCount: items?.length, containerClass: container.id });
      
      currentItems = items;  // Global tutarak sessionStorage'a kaydet
      sessionStorage.setItem(ITEMS_STORAGE_KEY, JSON.stringify(items));
      
      if (!items || items.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üòï</div>
            <p>Sonu√ß bulunamadƒ±</p>
          </div>
        `;
        return;
      }

      container.innerHTML = items.map((item, idx) => {
        // Hybrid rating: combined_rating > user_rating > external_rating > 0
        const rating = item.combined_rating || item.user_rating || item.external_rating || 0;
        const stars = rating > 0 ? '‚≠ê'.repeat(Math.floor(rating / 2)) + (rating % 2 !== 0 ? '‚ú®' : '') : '';
        
        // Item t√ºr√ºn√º belirle (DB veya API)
        const itemType = item.item_type || item.type || (item.source === 'tmdb' ? 'movie' : 'book');
        
        // Rating kaynaƒüƒ±nƒ± g√∂ster
        let ratingInfo = '';
        if (item.external_rating && !item.user_rating) {
          ratingInfo = ` <small style="color: #999; font-size: 0.8em;">(API)</small>`;
        } else if (item.user_rating && !item.external_rating) {
          ratingInfo = ` <small style="color: #999; font-size: 0.8em;">(Kullanƒ±cƒ±lar)</small>`;
        } else if (item.external_rating && item.user_rating) {
          ratingInfo = ` <small style="color: #999; font-size: 0.8em;">(Hibrid)</small>`;
        }
        
        return `
          <div class="result-card">
            <div class="result-card-image">
              <img 
                src="${item.poster_url || 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22250%22 height=%22180%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22250%22 height=%22180%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2214%22 fill=%22%23999%22 text-anchor=%22middle%22 dy=%22.3em%22%3ENo Image%3C/text%3E%3C/svg%3E'}" 
                alt="${item.title}"
                style="background-color: #f0f0f0;"
                onerror="this.style.backgroundColor='#f0f0f0'"
              />
              <span class="type-badge">${itemType === 'movie' ? 'üé¨ Film' : 'üìñ Kitap'}</span>
            </div>
            <div class="result-card-info">
              <div class="result-card-title">${item.title}</div>
              <div class="result-card-meta">${item.year || 'Tarih Bilinmiyor'}</div>
              <div class="result-card-rating">
                <span class="rating-stars">${stars || 'Hen√ºz Puan Yok'}</span>
                <span>(${rating ? rating.toFixed(1) : '0'}/10)${ratingInfo}</span>
              </div>
              <div class="result-card-buttons">
                ${item.item_id ? `
                  <button class="result-card-btn info detail-db-btn" data-item-id="${item.item_id}">üîç Detay</button>
                ` : `
                  <button class="result-card-btn info detail-api-btn" data-api-index="${idx}">üîç Detay</button>
                `}
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      // Event listeners ekle
      container.querySelectorAll('.detail-db-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          const itemId = btn.getAttribute('data-item-id');
          console.log(`üñ±Ô∏è DB Detay Butonu Tƒ±klandƒ± - ID: ${itemId}`);
          goToDetail(itemId);
        });
      });
      
      container.querySelectorAll('.detail-api-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          const apiIndex = parseInt(btn.getAttribute('data-api-index'));
          console.log(`üñ±Ô∏è API Detay Butonu Tƒ±klandƒ± - Index: ${apiIndex}`);
          goToDetailAPI(apiIndex);
        });
      });
    };

    // ============ DETAY SAYFASINA Gƒ∞T ============
    const goToDetail = (itemId) => {
      try {
        if (!itemId || itemId === 'undefined' || isNaN(itemId)) {
          throw new Error(`Ge√ßersiz item ID: ${itemId}`);
        }
        console.log(`‚úÖ DB Item Detayƒ±na Gidiliyor - ID: ${itemId}`);
        window.location.href = `items.html?id=${itemId}`;
      } catch (err) {
        console.error('‚ùå DB Detay Hatasƒ±:', err);
        alert(`‚ùå Detay a√ßƒ±lƒ±rken hata olu≈ütu:\n${err.message}`);
      }
    };

    const goToDetailAPI = (itemIndex) => {
      try {
        console.log(`üìç API ƒ∞√ßeriƒüi Detay ƒ∞steniliyor - Index: ${itemIndex}`);
        
        // SessionStorage'dan veya global arrayden al
        let items = currentItems;
        if (!items || items.length === 0) {
          const stored = sessionStorage.getItem(ITEMS_STORAGE_KEY);
          items = stored ? JSON.parse(stored) : [];
        }
        
        console.log(`üìä Mevcut ${items.length} adet API item var`);
        
        if (!items || items.length === 0) {
          throw new Error('Arama sonu√ßlarƒ± bulunamadƒ±. L√ºtfen tekrar arama yapƒ±n.');
        }
        
        const item = items[itemIndex];
        if (!item) {
          throw new Error(`Item index ${itemIndex} bulunamadƒ±. Toplam ${items.length} √∂ƒüe var.`);
        }
        
        // Item t√ºr√ºn√º kontrol et
        if (!item.title) {
          throw new Error('Item ba≈ülƒ±k bilgisi eksik. Item verisi: ' + JSON.stringify(item));
        }
        
        console.log('‚úÖ API ƒ∞√ßeriƒüi Bulundu:', {
          title: item.title,
          source: item.source,
          id: item.id,
          sourceId: item.sourceId
        });
        
        const itemJson = JSON.stringify(item);
        const encodedId = encodeURIComponent(itemJson);
        
        console.log(`‚úÖ API Item Detayƒ±na Gidiliyor - Title: ${item.title}, URL: items.html?id=...&source=api`);
        window.location.href = `items.html?id=${encodedId}&source=api`;
      } catch (err) {
        console.error('‚ùå API Detay Hatasƒ±:', err);
        alert(`‚ùå API ƒ∞√ßeriƒüi a√ßƒ±lƒ±rken hata olu≈ütu:\n\n${err.message}\n\nL√ºtfen tarayƒ±cƒ±nƒ±n developer tools'unu (F12) a√ßƒ±p console'u kontrol edin.`);
      }
    };

    // ============ ARAMA FONKSƒ∞YONU ============
    const performSearch = async () => {
      const query = searchInput.value.trim();
      
      if (query.length < 2) {
        alert('L√ºtfen en az 2 karakter yazƒ±n');
        return;
      }

      resultsContainer.innerHTML = '<div class="loading">Aranƒ±yor...</div>';

      try {
        // Hem veritabanƒ±ndan hem external API'den ara
        const dbUrl = `${API_URL}/search?q=${encodeURIComponent(query)}`;
        const token = sessionManager.getToken();
        const headers = token ? { "Authorization": `Bearer ${token}` } : {};
        
        console.log('üîç Veritabanƒ±nda aranƒ±yor:', dbUrl);
        console.log('üîç External API\'de aranƒ±yor (Film ve Kitap)');

        // Paralel olarak her ikisini de ara
        const [dbResponse, movieResponse, bookResponse] = await Promise.all([
          fetch(dbUrl),
          fetch(`${API_BASE}/external/search?type=movie&query=${encodeURIComponent(query)}`, { headers }).catch(() => null),
          fetch(`${API_BASE}/external/search?type=book&query=${encodeURIComponent(query)}`, { headers }).catch(() => null)
        ]);
        
        if (!dbResponse.ok) throw new Error('Veritabanƒ± Arama Hatasƒ±');

        const dbResults = await dbResponse.json();
        const movies = movieResponse?.ok ? await movieResponse.json() : [];
        const books = bookResponse?.ok ? await bookResponse.json() : [];
        
        // Her bir API result'a source bilgisi ekle
        movies.forEach(movie => {
          movie.source = 'tmdb';
          movie.sourceId = `tmdb_${movie.external_api_id || movie.id}`;
        });
        books.forEach(book => {
          book.source = book.provider === 'google' ? 'google_books' : 'openlib';
          book.sourceId = `${book.source}_${book.external_api_id || book.id}`;
        });
        
        console.log('üìö Veritabanƒ± Sonu√ßlarƒ±:', dbResults);
        console.log('üé¨ External API Film Sonu√ßlarƒ±:', movies);
        console.log('üìñ External API Kitap Sonu√ßlarƒ±:', books);

        // T√ºm sonu√ßlarƒ± birle≈ütir
        let allResults = [...dbResults, ...(movies || []), ...(books || [])];
        
        // Duplikatlarƒ± kaldƒ±r (aynƒ± title olanlar)
        const seen = new Set();
        allResults = allResults.filter(item => {
          const key = (item.title || '').toLowerCase();
          if (seen.has(key)) return false;
          seen.add(key);
          return true;
        });
        
        console.log(`üìä Toplam Sonu√ß Sayƒ±sƒ± (Birle≈ütirme Sonrasƒ±): ${allResults.length}`);

        // Fƒ∞LTRELEME
        if (filterType.value) {
          console.log(`üîΩ Tip Filtresi Uygulanƒ±yor: "${filterType.value}"`);
          allResults = allResults.filter(item => item.item_type === filterType.value);
          console.log(`üìä Sonu√ß Sayƒ±sƒ± (Tip Filtresi Sonrasƒ±): ${allResults.length}`);
        }

        if (filterYear.value) {
          allResults = allResults.filter(item => item.year == filterYear.value);
        }

        if (filterRating.value) {
          const minRating = parseFloat(filterRating.value);
          allResults = allResults.filter(item => (item.combined_rating || item.user_rating || item.external_rating || 0) >= minRating);
        }

        // SIRALAMA
        switch(sortBy.value) {
          case 'rating':
            allResults.sort((a, b) => (b.combined_rating || b.user_rating || b.external_rating || 0) - (a.combined_rating || a.user_rating || a.external_rating || 0));
            break;
          case 'popularity':
            allResults.sort((a, b) => (b.review_count || 0) - (a.review_count || 0));
            break;
          case 'newest':
            allResults.sort((a, b) => (b.year || 0) - (a.year || 0));
            break;
          default:
            // relevance (arama sonucu sƒ±rasƒ±)
            break;
        }

        renderResults(allResults, resultsContainer);
        
        // Arama state'ini kaydet
        currentItems = allResults;
        sessionStorage.setItem(ITEMS_STORAGE_KEY, JSON.stringify(allResults));
        const state = {
          query: query,
          filters: {
            type: filterType.value,
            year: filterYear.value,
            rating: filterRating.value,
            sort: sortBy.value
          }
        };
        sessionStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        console.log('üíæ Arama state kaydedildi');
      } catch (error) {
        console.error('Arama Hatasƒ±:', error);
        resultsContainer.innerHTML = `<div class="empty-state"><p>‚ùå Hata: ${error.message}</p></div>`;
      }
    };

    // ============ Vƒ∞TRƒ∞N: EN Y√úKSEK PUANLILAN ============
    const loadTopRated = async () => {
      try {
        const response = await fetch(`${API_URL}/featured/top-rated?limit=6`);
        if (!response.ok) throw new Error('API Hatasƒ±');
        
        let items = await response.json();
        
        // Her item'a sourceId ekle (API items i√ßin)
        items.forEach(item => {
          if (item.external_api_id && !item.item_id) {
            // Bu bir API item'ƒ± (database'de yoksa)
            item.source = item.external_api_source === 'tmdb' ? 'tmdb' : 
                         item.external_api_source === 'google_books' ? 'google_books' : 'openlib';
            item.sourceId = `${item.source}_${item.external_api_id}`;
          }
        });
        
        console.log('‚≠ê En Y√ºksek Puanlƒ±lar:', items);
        renderResults(items, topRatedContainer);
      } catch (error) {
        console.error('Top Rated Y√ºkleme Hatasƒ±:', error);
        topRatedContainer.innerHTML = `<div class="empty-state"><p>‚ö†Ô∏è Y√ºklenemedi</p></div>`;
      }
    };

    // ============ Vƒ∞TRƒ∞N: EN POP√úLERLERƒ∞ ============
    const loadPopular = async () => {
      try {
        const response = await fetch(`${API_URL}/featured/popular?limit=6`);
        if (!response.ok) throw new Error('API Hatasƒ±');
        
        let items = await response.json();
        
        // Her item'a sourceId ekle (API items i√ßin)
        items.forEach(item => {
          if (item.external_api_id && !item.item_id) {
            // Bu bir API item'ƒ± (database'de yoksa)
            item.source = item.external_api_source === 'tmdb' ? 'tmdb' : 
                         item.external_api_source === 'google_books' ? 'google_books' : 'openlib';
            item.sourceId = `${item.source}_${item.external_api_id}`;
          }
        });
        
        console.log('üî• En Pop√ºlerler:', items);
        renderResults(items, mostPopularContainer);
      } catch (error) {
        console.error('Most Popular Y√ºkleme Hatasƒ±:', error);
        mostPopularContainer.innerHTML = `<div class="empty-state"><p>‚ö†Ô∏è Y√ºklenemedi</p></div>`;
      }
    };

    // ============ EVENT Lƒ∞STENERS ============
    searchBtn.addEventListener('click', performSearch);
    searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') performSearch();
    });

    // Filtreler deƒüi≈üince otomatik arama yap
    [filterType, filterYear, filterRating, sortBy].forEach(filter => {
      filter.addEventListener('change', () => {
        if (searchInput.value.trim().length >= 2) {
          performSearch();
        }
      });
    });

    clearFiltersBtn.addEventListener('click', () => {
      searchInput.value = '';
      filterType.value = '';
      filterYear.value = '';
      filterRating.value = '';
      sortBy.value = 'relevance';
      resultsContainer.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">üîç</div>
          <p>Aramaya ba≈ülamak i√ßin yukarƒ±ya bir ≈üey yazƒ±n ve Ara butonuna tƒ±klayƒ±n</p>
        </div>
      `;
    });

    // ============ BA≈ûLANGI√á ============
    if (!sessionManager.isLoggedIn()) {
      resultsContainer.innerHTML = `
        <div class="auth-message">
          <h3>üëã Ho≈ü geldiniz!</h3>
          <p>Ke≈üfet √∂zelliƒüini kullanmak i√ßin l√ºtfen giri≈ü yapƒ±nƒ±z.</p>
          <a href="./login.html">Giri≈ü Yap veya Kayƒ±t Ol</a>
        </div>
      `;
      topRatedContainer.innerHTML = resultsContainer.innerHTML;
      mostPopularContainer.innerHTML = resultsContainer.innerHTML;
    } else {
      // √ñnceki arama sonu√ßlarƒ±nƒ± restore et
      const savedState = sessionStorage.getItem(STORAGE_KEY);
      if (savedState) {
        try {
          const state = JSON.parse(savedState);
          searchInput.value = state.query || '';
          filterType.value = state.filters?.type || '';
          filterYear.value = state.filters?.year || '';
          filterRating.value = state.filters?.rating || '';
          sortBy.value = state.filters?.sort || 'relevance';
          
          const savedItems = sessionStorage.getItem(ITEMS_STORAGE_KEY);
          if (savedItems) {
            currentItems = JSON.parse(savedItems);
            renderResults(currentItems, resultsContainer);
            console.log('‚úÖ √ñnceki arama geri y√ºklendi:', state.query);
          }
        } catch (e) {
          console.error('Arama restore hatasƒ±:', e);
          loadTopRated();
          loadPopular();
        }
      } else {
        // ƒ∞lk ziyaret - vitrin b√∂l√ºmlerini y√ºkle
        loadTopRated();
        loadPopular();
      }
    }
  </script>
</body>
</html>
