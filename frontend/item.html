<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ƒ∞√ßerik Detayƒ± ‚Ä¢ BiblioNet</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #f8f9fa;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }

    main {
      padding: 40px 20px;
      max-width: 1000px;
      margin: 0 auto;
    }

    /* ============ HEADER ============ */
    header {
      background: white;
      padding: 20px 0;
      border-bottom: 1px solid #e0e0e0;
      margin-bottom: 30px;
    }

    nav {
      max-width: 1000px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .nav-btn {
      background: none;
      border: none;
      color: #667eea;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      padding: 8px 12px;
    }

    .nav-btn:hover {
      text-decoration: underline;
    }

    /* ============ CONTAINER ============ */
    .detail-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .detail-header {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 40px;
      padding: 40px;
    }

    .detail-cover {
      position: relative;
    }

    .detail-cover img {
      width: 100%;
      height: auto;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .type-badge {
      position: absolute;
      top: 12px;
      right: 12px;
      background: #667eea;
      color: white;
      padding: 8px 14px;
      border-radius: 6px;
      font-weight: 600;
      font-size: 14px;
    }

    .detail-info h1 {
      font-size: 32px;
      color: #333;
      margin-bottom: 15px;
    }

    .detail-meta {
      margin-bottom: 25px;
    }

    .meta-item {
      margin-bottom: 8px;
      color: #666;
      font-size: 15px;
      line-height: 1.5;
    }

    .meta-label {
      font-weight: 600;
      color: #333;
    }

    /* ============ RATING ============ */
    .rating-box {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 25px;
    }

    .rating-display {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 15px;
    }

    .rating-big {
      font-size: 48px;
      font-weight: bold;
      color: #667eea;
      min-width: 80px;
    }

    .rating-info {
      flex: 1;
    }

    .rating-text {
      font-size: 14px;
      color: #666;
    }

    .rating-stars {
      font-size: 18px;
      margin-top: 5px;
    }

    .rating-input-group {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-top: 15px;
    }

    .rating-label {
      font-weight: 600;
      color: #333;
    }

    .rating-stars-input {
      display: flex;
      gap: 8px;
    }

    .star-btn {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .star-btn:hover {
      transform: scale(1.15);
    }

    .star-btn.selected {
      filter: drop-shadow(0 0 3px gold);
    }

    .submit-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102,126,234,0.4);
    }

    /* ============ ACTION BUTTONS ============ */
    .action-buttons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 20px;
    }

    .action-btn {
      padding: 13px 18px;
      border: 2px solid #667eea;
      background: white;
      color: #667eea;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s;
    }

    .action-btn:hover {
      background: #667eea;
      color: white;
    }

    .action-btn.secondary {
      border-color: #764ba2;
      color: #764ba2;
    }

    .action-btn.secondary:hover {
      background: #764ba2;
      color: white;
    }

    /* ============ DESCRIPTION ============ */
    .description-section {
      padding: 40px;
      border-top: 1px solid #e0e0e0;
    }

    .section-title {
      font-size: 20px;
      font-weight: 600;
      color: #333;
      margin-bottom: 15px;
    }

    .description-text {
      color: #666;
      line-height: 1.8;
      font-size: 15px;
    }

    /* ============ COMMENTS ============ */
    .comments-section {
      padding: 40px;
      border-top: 1px solid #e0e0e0;
    }

    .comment-form {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 25px;
    }

    .comment-form textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      min-height: 100px;
      margin-bottom: 10px;
    }

    .comment-form textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
    }

    .comments-list {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .comment-item {
      background: #f8f9fa;
      padding: 18px;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }

    .comment-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }

    .comment-user {
      font-weight: 600;
      color: #333;
    }

    .comment-date {
      font-size: 12px;
      color: #999;
    }

    .comment-text {
      color: #666;
      line-height: 1.6;
      font-size: 14px;
      margin-bottom: 10px;
    }

    .comment-actions {
      display: flex;
      gap: 12px;
    }

    .comment-btn {
      background: none;
      border: none;
      color: #667eea;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      padding: 4px 8px;
    }

    .comment-btn:hover {
      color: #764ba2;
      text-decoration: underline;
    }

    /* ============ EMPTY STATE ============ */
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #667eea;
    }

    @media (max-width: 768px) {
      .detail-header {
        grid-template-columns: 1fr;
        gap: 25px;
        padding: 20px;
      }

      .detail-info h1 {
        font-size: 24px;
      }

      .action-buttons {
        grid-template-columns: 1fr;
      }

      .rating-display {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <header>
    <nav>
      <button class="nav-btn" onclick="window.history.back()">‚Üê Geri</button>
    </nav>
  </header>

  <main>
    <div id="loading" class="loading">‚è≥ Y√ºkleniyor...</div>
    <div id="content" style="display: none;"></div>
    <div id="error" class="empty-state" style="display: none;"></div>
  </main>

  <script>
    const API_BASE = "http://127.0.0.1:8000";
    const API_URL = `${API_BASE}/items`;

    let currentItem = null;
    let currentUser = { user_id: 1, username: "demo_user" };
    let selectedRating = 0;

    const urlParams = new URLSearchParams(window.location.search);
    const itemId = urlParams.get('id');

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('tr-TR', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function renderStars(rating) {
      const stars = Math.floor(rating / 2);
      const remainder = rating % 2;
      let result = '‚≠ê'.repeat(stars);
      if (remainder !== 0) result += '‚ú®';
      return result || 'Hen√ºz Puan Yok';
    }

    async function loadItemDetails() {
      try {
        const response = await fetch(`${API_URL}/${itemId}`);
        if (!response.ok) throw new Error('ƒ∞√ßerik bulunamadƒ±');

        currentItem = await response.json();
        console.log('üìñ ƒ∞√ßerik:', currentItem);
        
        renderItemDetail();
        loadComments();
      } catch (error) {
        console.error('Hata:', error);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
        document.getElementById('error').innerHTML = '‚ö†Ô∏è ƒ∞√ßerik y√ºklenemedi';
      }
    }

    function renderItemDetail() {
      const item = currentItem;
      const rating = item.combined_rating || item.user_rating || item.external_rating || 0;
      const stars = renderStars(rating);

      const html = `
        <div class="detail-container">
          <div class="detail-header">
            <div class="detail-cover">
              <img src="${item.poster_url || 'https://via.placeholder.com/280x400?text=' + encodeURIComponent(item.title)}" 
                   alt="${item.title}" onerror="this.src='https://via.placeholder.com/280x400?text=G√∂rsel+Yok'" />
              <span class="type-badge">${item.item_type === 'movie' ? 'üé¨ Film' : 'üìñ Kitap'}</span>
            </div>

            <div class="detail-info">
              <h1>${item.title}</h1>
              
              <div class="detail-meta">
                <div class="meta-item"><span class="meta-label">Yƒ±l:</span> ${item.year || 'Bilinmiyor'}</div>
                ${item.authors ? `<div class="meta-item"><span class="meta-label">Yazar:</span> ${item.authors}</div>` : ''}
                ${item.director ? `<div class="meta-item"><span class="meta-label">Y√∂netmen:</span> ${item.director}</div>` : ''}
                ${item.actors ? `<div class="meta-item"><span class="meta-label">Oyuncular:</span> ${item.actors}</div>` : ''}
                ${item.genres ? `<div class="meta-item"><span class="meta-label">T√ºr:</span> ${item.genres}</div>` : ''}
                ${item.page_count ? `<div class="meta-item"><span class="meta-label">Sayfa:</span> ${item.page_count}</div>` : ''}
              </div>

              <div class="rating-box">
                <div class="rating-display">
                  <div class="rating-big">${rating.toFixed(1)}</div>
                  <div class="rating-info">
                    <div class="rating-text">Ortalama Puan</div>
                    <div class="rating-text">${item.review_count || 0} Oy</div>
                    <div class="rating-stars">${stars}</div>
                  </div>
                </div>

                <div class="rating-input-group">
                  <label class="rating-label">Puan Ver:</label>
                  <div class="rating-stars-input" id="ratingInput"></div>
                  <button class="submit-btn" onclick="submitRating()">G√∂nder</button>
                </div>
              </div>

              <div class="action-buttons">
                ${item.item_type === 'book' ? `
                  <button class="action-btn" onclick="toggleLibrary('read')">üìö Okudum</button>
                  <button class="action-btn" onclick="toggleLibrary('toread')">üìñ Okunacak</button>
                ` : `
                  <button class="action-btn" onclick="toggleLibrary('watched')">üé¨ ƒ∞zledim</button>
                  <button class="action-btn" onclick="toggleLibrary('towatch')">‚è±Ô∏è ƒ∞zlenecek</button>
                `}
                <button class="action-btn secondary" onclick="addCustomList()">üìã √ñzel Listeye</button>
              </div>
            </div>
          </div>

          ${item.description ? `
            <div class="description-section">
              <div class="section-title">üìù √ñzet</div>
              <div class="description-text">${item.description}</div>
            </div>
          ` : ''}

          <div class="comments-section">
            <div class="section-title">üí¨ Yorumlar</div>
            
            <div class="comment-form">
              <textarea id="commentText" placeholder="Yorumunuzu yazƒ±n..."></textarea>
              <button class="submit-btn" onclick="submitComment()">G√∂nder</button>
            </div>

            <div id="commentsList" class="comments-list"></div>
          </div>
        </div>
      `;

      document.getElementById('loading').style.display = 'none';
      document.getElementById('content').style.display = 'block';
      document.getElementById('content').innerHTML = html;

      initRatingInput();
    }

    function initRatingInput() {
      const container = document.getElementById('ratingInput');
      container.innerHTML = '';
      for (let i = 1; i <= 10; i++) {
        const btn = document.createElement('button');
        btn.className = 'star-btn';
        btn.textContent = i <= 5 ? '‚≠ê' : '‚ú®';
        btn.onclick = () => selectRating(i);
        container.appendChild(btn);
      }
    }

    function selectRating(rating) {
      selectedRating = rating;
      document.querySelectorAll('.star-btn').forEach((btn, idx) => {
        btn.classList.toggle('selected', idx < rating);
      });
    }

    function submitRating() {
      if (!selectedRating) {
        alert('L√ºtfen bir puan se√ßin');
        return;
      }
      console.log(`‚≠ê ${selectedRating}/10 puan verildi`);
      alert(`${selectedRating}/10 puan ba≈üarƒ±yla kaydedildi!`);
      selectedRating = 0;
      initRatingInput();
    }

    function toggleLibrary(action) {
      console.log(`üìö ${action} i≈ülemi:`, itemId);
      alert(`${action} i≈ülemi yapƒ±ldƒ±! (Demo)`);
    }

    function addCustomList() {
      console.log('üìã √ñzel listeye ekle');
      alert('√ñzel listeler men√ºs√º a√ßƒ±lacak (Demo)');
    }

    async function loadComments() {
      try {
        const response = await fetch(`${API_URL}/${itemId}/comments`);
        const comments = response.ok ? await response.json() : [];
        renderComments(comments);
      } catch (error) {
        console.log('Yorumlar y√ºklenemedi');
      }
    }

    function renderComments(comments) {
      const container = document.getElementById('commentsList');
      
      if (!comments || !comments.length) {
        container.innerHTML = '<div class="empty-state">Hen√ºz yorum yok. ƒ∞lk yorum yapan siz olun!</div>';
        return;
      }

      container.innerHTML = comments.map(comment => `
        <div class="comment-item">
          <div class="comment-header">
            <span class="comment-user">üë§ ${comment.user_id || 'Anonim'}</span>
            <span class="comment-date">${formatDate(comment.created_at)}</span>
          </div>
          <div class="comment-text">${comment.review_text}</div>
          ${comment.user_id === currentUser.user_id ? `
            <div class="comment-actions">
              <button class="comment-btn">‚úèÔ∏è D√ºzenle</button>
              <button class="comment-btn" onclick="deleteComment(${comment.review_id})">üóëÔ∏è Sil</button>
            </div>
          ` : ''}
        </div>
      `).join('');
    }

    async function submitComment() {
      const text = document.getElementById('commentText').value.trim();
      if (!text) {
        alert('L√ºtfen bir yorum yazƒ±n');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/${itemId}/comments`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_id: currentUser.user_id,
            review_text: text
          })
        });

        if (response.ok) {
          document.getElementById('commentText').value = '';
          loadComments();
        }
      } catch (error) {
        alert('Yorum g√∂nderilemedi');
      }
    }

    function deleteComment(reviewId) {
      if (confirm('Yorumu silmek istediƒüinize emin misiniz?')) {
        console.log('Yorum silme:', reviewId);
        alert('Yorum silindi (Demo)');
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      if (!itemId) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
        document.getElementById('error').innerHTML = '‚ùå ƒ∞√ßerik se√ßilmedi';
        return;
      }
      loadItemDetails();
    });
  </script>
</body>
</html>