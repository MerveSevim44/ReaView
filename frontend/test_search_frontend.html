<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Frontend Search Test</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f5f5f5; }
    .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
    button { padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
    button:hover { background: #764ba2; }
    .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 20px 0; }
    .stat { background: #f0f0f0; padding: 15px; border-radius: 4px; text-align: center; }
    .stat-number { font-size: 24px; font-weight: bold; color: #667eea; }
    .results { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 20px; }
    .card { background: #f9f9f9; border: 1px solid #ddd; padding: 10px; border-radius: 4px; text-align: center; }
    .card-title { font-weight: bold; margin-bottom: 5px; }
    .card-meta { font-size: 12px; color: #666; }
    .source { display: inline-block; margin-top: 5px; padding: 2px 6px; background: #ddd; border-radius: 3px; font-size: 10px; }
    .db { background: #c3e7ff; }
    .api { background: #fff3cd; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Frontend Search Test</h1>
    <button onclick="testSearch()">Test: 'harry' Ara</button>
    
    <div class="stats">
      <div class="stat">
        <div class="stat-label">Veritabanƒ±</div>
        <div class="stat-number" id="dbCount">0</div>
      </div>
      <div class="stat">
        <div class="stat-label">External API</div>
        <div class="stat-number" id="apiCount">0</div>
      </div>
      <div class="stat">
        <div class="stat-label">Duplikat Kaldƒ±rƒ±ldƒ±</div>
        <div class="stat-number" id="dupCount">0</div>
      </div>
      <div class="stat">
        <div class="stat-label">Toplam</div>
        <div class="stat-number" id="totalCount">0</div>
      </div>
    </div>
    
    <div id="results"></div>
  </div>

  <script>
    const API_BASE = "http://127.0.0.1:8000";
    const API_URL = `${API_BASE}/items`;

    async function testSearch() {
      const query = "harry";
      
      console.clear();
      console.log("üîç Frontend Search Simulasyonu Ba≈üladƒ±");
      
      try {
        // Step 1: Veritabanƒ±ndan ara
        console.log("\n1Ô∏è‚É£ Veritabanƒ±ndan aranƒ±yor...");
        const dbUrl = `${API_URL}/search?q=${query}`;
        const dbResponse = await fetch(dbUrl);
        const dbResults = await dbResponse.json();
        console.log(`   ‚úÖ ${dbResults.length} sonu√ß bulundu`);
        console.log("   Sonu√ßlar:", dbResults);
        
        // Step 2: External API'den ara
        console.log("\n2Ô∏è‚É£ External API'den aranƒ±yor...");
        const movieUrl = `${API_BASE}/external/search?type=movie&query=${query}`;
        const bookUrl = `${API_BASE}/external/search?type=book&query=${query}`;
        
        const [movieResp, bookResp] = await Promise.all([
          fetch(movieUrl).catch(() => null),
          fetch(bookUrl).catch(() => null)
        ]);
        
        const movies = movieResp?.ok ? await movieResp.json() : [];
        const books = bookResp?.ok ? await bookResp.json() : [];
        
        console.log(`   ‚úÖ ${movies.length} film + ${books.length} kitap = ${movies.length + books.length} toplam`);
        console.log("   Filmler:", movies);
        console.log("   Kitaplar:", books);
        
        // Step 3: Birle≈ütir
        console.log("\n3Ô∏è‚É£ T√ºm sonu√ßlar birle≈ütiriliyor...");
        let allResults = [...dbResults, ...movies, ...books];
        console.log(`   Birle≈ütirilmi≈ü toplam: ${allResults.length} sonu√ß`);
        
        // Step 4: Duplikat kaldƒ±r
        console.log("\n4Ô∏è‚É£ Duplikat sonu√ßlar kaldƒ±rƒ±lƒ±yor...");
        const seen = new Set();
        const originalCount = allResults.length;
        allResults = allResults.filter(item => {
          const key = (item.title || '').toLowerCase();
          if (seen.has(key)) {
            console.log(`   ‚ùå Duplikat bulundu: "${item.title}"`);
            return false;
          }
          seen.add(key);
          return true;
        });
        const dupCount = originalCount - allResults.length;
        console.log(`   ‚úÖ Duplikat Kaldƒ±rƒ±ldƒ±: ${dupCount} sonu√ß`);
        
        // Display stats
        document.getElementById('dbCount').textContent = dbResults.length;
        document.getElementById('apiCount').textContent = movies.length + books.length;
        document.getElementById('dupCount').textContent = dupCount;
        document.getElementById('totalCount').textContent = allResults.length;
        
        // Display results
        let html = `<h2>Sonu√ßlar (Toplam: ${allResults.length})</h2>`;
        html += `<div class="results">`;
        
        allResults.forEach((item, idx) => {
          const isDB = item.item_id ? true : false;
          const source = isDB ? 'Veritabanƒ±' : 'External API';
          html += `
            <div class="card">
              <div class="card-title">${item.title.substring(0, 30)}</div>
              <div class="card-meta">${item.year || '?'}</div>
              <span class="source ${isDB ? 'db' : 'api'}">${source}</span>
            </div>
          `;
        });
        
        html += `</div>`;
        document.getElementById('results').innerHTML = html;
        
        console.log("\n" + "=".repeat(60));
        console.log("‚úÖ Arama Tamamlandƒ±");
        console.log(`üìä Toplam Sonu√ß: ${allResults.length}`);
        
      } catch (error) {
        console.error("‚ùå Error:", error);
        alert("Hata: " + error.message);
      }
    }
  </script>
</body>
</html>
